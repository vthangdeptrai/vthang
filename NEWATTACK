local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local player = game:GetService("Players").LocalPlayer
local net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")

local registerAttack = net:FindFirstChild("RegisterAttack") or net:FindFirstChild("RE/RegisterAttack")
local registerHit = net:FindFirstChild("RegisterHit") or net:FindFirstChild("RE/RegisterHit")

-- CẤU HÌNH ĐÃ TỐI ƯU (KHÔNG GÂY ĐỨNG MÁY)
local HIT_MULTIPLIER = 5 -- Giảm xuống mức ổn định (Vẫn rất nhanh)
local AOE_RANGE = 5000 
local ATTACK_SPEED = 0.05 -- Tốc độ đánh cực nhanh (tương đương 20 lần/s)

task.spawn(function()
    while task.wait(ATTACK_SPEED) do
        local char = player.Character
        local root = char and char:FindFirstChild("HumanoidRootPart")
        local enemiesFolder = workspace:FindFirstChild("Enemies")

        if root and enemiesFolder then
            -- Chỉ vung chiêu 1 lần để tránh lag
            registerAttack:FireServer(1)

            local enemies = enemiesFolder:GetChildren()
            for _, npc in ipairs(enemies) do
                local hum = npc:FindFirstChildOfClass("Humanoid")
                local hitPart = npc:FindFirstChild("Head") or npc:FindFirstChild("HumanoidRootPart")

                if hum and hum.Health > 0 and hitPart then
                    local dist = (hitPart.Position - root.Position).Magnitude
                    if dist <= AOE_RANGE then
                        -- Gửi lệnh đánh theo đợt (Batching)
                        for i = 1, HIT_MULTIPLIER do
                            registerHit:FireServer(hitPart, {}, "default_code", 0.5)
                        end
                    end
                end
            end
        end
    end
end)
